import React, { useState, useEffect } from ‚Äòreact‚Äô;
import { Trophy, Star, Target, Clock, CheckCircle, XCircle, BarChart3, Zap, Play, Book, Settings, ArrowLeft } from ‚Äòlucide-react‚Äô;

const GangetabelApp = () => {
// State management
const [currentMode, setCurrentMode] = useState(‚Äòmenu‚Äô); // menu, lookup, practice, stats, settings
const [selectedTables, setSelectedTables] = useState([2, 3, 4, 5]);
const [practiceType, setPracticeType] = useState(‚Äòmultiple‚Äô); // multiple or input
const [practiceLength, setPracticeLength] = useState(10); // number of questions per session
const [currentQuestion, setCurrentQuestion] = useState(null);
const [userAnswer, setUserAnswer] = useState(‚Äô‚Äô);
const [feedback, setFeedback] = useState(null);
const [sessionStats, setSessionStats] = useState({ correct: 0, total: 0 });
const [streak, setStreak] = useState(0);
const [showNextButton, setShowNextButton] = useState(false);
const [isSessionActive, setIsSessionActive] = useState(false);

// Progress tracking
const [progress, setProgress] = useState(() => {
const saved = localStorage.getItem(‚ÄògangetabelProgress‚Äô);
return saved ? JSON.parse(saved) : {
facts: {}, // { ‚Äú3x4‚Äù: { correct: 0, attempts: 0, lastSeen: null, nextReview: null } }
totalPoints: 0,
level: 1,
dailyStreak: 0,
lastPractice: null
};
});

// Save progress
useEffect(() => {
localStorage.setItem(‚ÄògangetabelProgress‚Äô, JSON.stringify(progress));
}, [progress]);

// Generate question based on selected tables and spaced repetition
const generateQuestion = () => {
const now = Date.now();
let candidates = [];

```
// Check for due reviews
selectedTables.forEach(table => {
  for (let i = 1; i <= 10; i++) {
    const key = `${table}x${i}`;
    const fact = progress.facts[key];
    
    if (!fact || !fact.nextReview || fact.nextReview <= now) {
      candidates.push({ a: table, b: i, priority: fact ? 1 : 2 });
    }
  }
});

// If no due reviews, add some random facts
if (candidates.length < 5) {
  selectedTables.forEach(table => {
    for (let i = 1; i <= 10; i++) {
      if (Math.random() < 0.3) {
        candidates.push({ a: table, b: i, priority: 0 });
      }
    }
  });
}

// If still no candidates, just add all possible combinations
if (candidates.length === 0) {
  selectedTables.forEach(table => {
    for (let i = 1; i <= 10; i++) {
      candidates.push({ a: table, b: i, priority: 0 });
    }
  });
}

// Sort by priority and pick one
candidates.sort((a, b) => b.priority - a.priority);
const question = candidates[Math.floor(Math.random() * Math.min(4, candidates.length))];

if (question) {
  const correctAnswer = question.a * question.b;
  let options = [correctAnswer];
  
  // Generate plausible wrong answers
  while (options.length < 4) {
    const wrongAnswer = correctAnswer + (Math.random() < 0.5 ? -1 : 1) * 
                       Math.floor(Math.random() * 10 + 1);
    if (wrongAnswer > 0 && !options.includes(wrongAnswer)) {
      options.push(wrongAnswer);
    }
  }
  
  // Shuffle options
  options.sort(() => Math.random() - 0.5);
  
  setCurrentQuestion({
    ...question,
    answer: correctAnswer,
    options: options
  });
}
```

};

// Handle answer submission
const handleAnswer = (answer) => {
const isCorrect = answer === currentQuestion.answer;
const key = `${currentQuestion.a}x${currentQuestion.b}`;

```
// Update progress with spaced repetition intervals
setProgress(prev => {
  const newFacts = { ...prev.facts };
  const fact = newFacts[key] || { correct: 0, attempts: 0 };
  
  fact.attempts++;
  if (isCorrect) {
    fact.correct++;
    fact.lastSeen = Date.now();
    
    // Calculate next review time based on performance
    const accuracy = fact.correct / fact.attempts;
    let interval;
    if (accuracy >= 0.9) {
      interval = 7 * 24 * 60 * 60 * 1000; // 7 days
    } else if (accuracy >= 0.7) {
      interval = 3 * 24 * 60 * 60 * 1000; // 3 days
    } else if (accuracy >= 0.5) {
      interval = 24 * 60 * 60 * 1000; // 1 day
    } else {
      interval = 60 * 60 * 1000; // 1 hour
    }
    fact.nextReview = Date.now() + interval;
  }
  
  newFacts[key] = fact;
  
  return {
    ...prev,
    facts: newFacts,
    totalPoints: prev.totalPoints + (isCorrect ? 10 : 0),
    level: Math.floor((prev.totalPoints + (isCorrect ? 10 : 0)) / 100) + 1,
    lastPractice: Date.now()
  };
});

// Update session stats
setSessionStats(prev => ({
  correct: prev.correct + (isCorrect ? 1 : 0),
  total: prev.total + 1
}));

setStreak(isCorrect ? streak + 1 : 0);
setFeedback({ isCorrect, correctAnswer: currentQuestion.answer });
setShowNextButton(true);
```

};

// Handle next question
const handleNextQuestion = () => {
setShowNextButton(false);
setFeedback(null);
setUserAnswer(‚Äô‚Äô);
generateQuestion();
};

// Settings component
const SettingsPage = () => {
return (
<div className="p-4 max-w-md mx-auto">
<div className="flex items-center gap-4 mb-6">
<button
onClick={() => setCurrentMode(‚Äòmenu‚Äô)}
className=‚Äúflex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors‚Äù
>
<ArrowLeft className="w-5 h-5" />
<span>Tilbage</span>
</button>
<h2 className="text-2xl font-bold">Indstillinger</h2>
</div>

```
    <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h3 className="font-bold text-lg mb-4">V√¶lg tabeller til √∏velser</h3>
      <div className="grid grid-cols-5 gap-2 mb-6">
        {[1,2,3,4,5,6,7,8,9,10].map(n => (
          <button
            key={n}
            onClick={() => {
              setSelectedTables(prev => 
                prev.includes(n) 
                  ? prev.filter(t => t !== n)
                  : [...prev, n]
              );
            }}
            className={`p-3 rounded-lg font-medium transition-all ${
              selectedTables.includes(n)
                ? 'bg-blue-500 text-white'
                : 'bg-gray-100 hover:bg-gray-200'
            }`}
          >
            {n}
          </button>
        ))}
      </div>
      <p className="text-sm text-gray-600">
        Valgte tabeller: {selectedTables.sort((a,b) => a-b).join(', ')}
      </p>
    </div>

    <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h3 className="font-bold text-lg mb-4">√òvelsestype</h3>
      <div className="space-y-3">
        <label className="flex items-center p-3 rounded-lg cursor-pointer hover:bg-gray-50">
          <input
            type="radio"
            checked={practiceType === 'multiple'}
            onChange={() => setPracticeType('multiple')}
            className="mr-3"
          />
          <div>
            <p className="font-medium">Valgmuligheder</p>
            <p className="text-sm text-gray-600">V√¶lg mellem 4 mulige svar</p>
          </div>
        </label>
        <label className="flex items-center p-3 rounded-lg cursor-pointer hover:bg-gray-50">
          <input
            type="radio"
            checked={practiceType === 'input'}
            onChange={() => setPracticeType('input')}
            className="mr-3"
          />
          <div>
            <p className="font-medium">Indtast svar</p>
            <p className="text-sm text-gray-600">Skriv svaret selv</p>
          </div>
        </label>
      </div>
    </div>

    <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h3 className="font-bold text-lg mb-4">Antal opgaver per √∏velse</h3>
      <div className="space-y-3">
        {[5, 10, 15, 20].map(num => (
          <label key={num} className="flex items-center p-3 rounded-lg cursor-pointer hover:bg-gray-50">
            <input
              type="radio"
              checked={practiceLength === num}
              onChange={() => setPracticeLength(num)}
              className="mr-3"
            />
            <div>
              <p className="font-medium">{num} opgaver</p>
              <p className="text-sm text-gray-600">
                {num === 5 && 'Hurtig √∏velse'}
                {num === 10 && 'Standard √∏velse'}
                {num === 15 && 'L√¶ngere √∏velse'}
                {num === 20 && 'Grundig √∏velse'}
              </p>
            </div>
          </label>
        ))}
      </div>
    </div>

    <button
      onClick={() => {
        if (window.confirm('Er du sikker p√• at du vil nulstille alle dine fremskridt?')) {
          setProgress({
            facts: {},
            totalPoints: 0,
            level: 1,
            dailyStreak: 0,
            lastPractice: null
          });
          alert('Dine fremskridt er blevet nulstillet!');
        }
      }}
      className="w-full p-3 text-red-600 bg-red-50 rounded-lg hover:bg-red-100 transition-colors"
    >
      Nulstil alle fremskridt
    </button>
  </div>
);
```

};

// Lookup table component
const LookupTable = () => {
const [selectedTable, setSelectedTable] = useState(5);

```
return (
  <div className="p-4 max-w-md mx-auto">
    <div className="flex items-center gap-4 mb-6">
      <button
        onClick={() => setCurrentMode('menu')}
        className="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors"
      >
        <ArrowLeft className="w-5 h-5" />
        <span>Tilbage</span>
      </button>
      <h2 className="text-2xl font-bold">Gangetabeller</h2>
    </div>
    
    <div className="flex gap-2 mb-6 flex-wrap">
      {[1,2,3,4,5,6,7,8,9,10].map(n => (
        <button
          key={n}
          onClick={() => setSelectedTable(n)}
          className={`px-4 py-2 rounded-lg font-medium transition-all ${
            selectedTable === n 
              ? 'bg-blue-500 text-white transform scale-110' 
              : 'bg-gray-100 hover:bg-gray-200'
          }`}
        >
          {n}
        </button>
      ))}
    </div>
    
    <div className="bg-white rounded-lg shadow-lg p-6">
      <h3 className="text-xl font-bold mb-4 text-center text-blue-600">{selectedTable}-tabellen</h3>
      <div className="grid grid-cols-2 gap-3">
        {[1,2,3,4,5,6,7,8,9,10].map(i => {
          const key = `${selectedTable}x${i}`;
          const fact = progress.facts[key];
          const isLearned = fact && fact.correct / fact.attempts >= 0.8 && fact.attempts >= 3;
          
          return (
            <div key={i} className={`p-3 rounded-lg text-center transition-all ${
              isLearned ? 'bg-green-50 border-2 border-green-200' : 'bg-gray-50'
            }`}>
              <span className="text-lg font-medium">
                {selectedTable} √ó {i} = {selectedTable * i}
              </span>
              {isLearned && (
                <Star className="w-4 h-4 text-green-500 mx-auto mt-1" />
              )}
            </div>
          );
        })}
      </div>
    </div>
  </div>
);
```

};

// Practice component
const Practice = () => {
useEffect(() => {
if (!isSessionActive) {
generateQuestion();
setSessionStats({ correct: 0, total: 0 });
setStreak(0);
setIsSessionActive(true);
}
}, [isSessionActive]);

```
const handleEndSession = () => {
  if (sessionStats.total === 0 || window.confirm('Er du sikker p√• at du vil afslutte √∏velsen?')) {
    setIsSessionActive(false);
    setFeedback(null);
    setShowNextButton(false);
    setCurrentMode('menu');
  }
};

const handleNextQuestion = () => {
  if (sessionStats.total >= practiceLength) {
    // Session complete
    setIsSessionActive(false);
    setCurrentMode('menu');
    alert(`Godt g√•et! Du fik ${sessionStats.correct} ud af ${practiceLength} rigtige!`);
  } else {
    setShowNextButton(false);
    setFeedback(null);
    setUserAnswer('');
    generateQuestion();
  }
};

if (!currentQuestion) return null;

const progressPercentage = (sessionStats.total / practiceLength) * 100;

return (
  <div className="p-4 max-w-md mx-auto">
    <div className="flex justify-between items-center mb-4">
      <button
        onClick={handleEndSession}
        className="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors"
      >
        <ArrowLeft className="w-5 h-5" />
        <span>Afslut</span>
      </button>
      
      <div className="flex gap-4">
        <div className="flex items-center gap-1 bg-blue-50 px-3 py-1 rounded-full">
          <Target className="w-4 h-4 text-blue-500" />
          <span className="font-medium">{sessionStats.correct}/{sessionStats.total}</span>
        </div>
        {streak > 2 && (
          <div className="flex items-center gap-1 bg-yellow-50 px-3 py-1 rounded-full">
            <Zap className="w-4 h-4 text-yellow-500" />
            <span className="font-medium">{streak}</span>
          </div>
        )}
      </div>
    </div>

    {/* Progress bar */}
    <div className="mb-6">
      <div className="flex justify-between text-sm text-gray-600 mb-1">
        <span>Opgave {sessionStats.total + 1} af {practiceLength}</span>
        <span>{Math.round(progressPercentage)}%</span>
      </div>
      <div className="w-full bg-gray-200 rounded-full h-3">
        <div 
          className="bg-gradient-to-r from-blue-400 to-blue-600 h-3 rounded-full transition-all duration-300"
          style={{ width: `${progressPercentage}%` }}
        />
      </div>
    </div>

    <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
      <h2 className="text-4xl font-bold text-center mb-8">
        {currentQuestion.a} √ó {currentQuestion.b} = ?
      </h2>

      {practiceType === 'multiple' ? (
        <div className="grid grid-cols-2 gap-4">
          {currentQuestion.options.map((option, idx) => (
            <button
              key={idx}
              onClick={() => {
                if (!feedback) {
                  handleAnswer(option);
                }
              }}
              disabled={feedback !== null}
              className={`p-4 text-xl font-medium rounded-lg transition-all ${
                feedback && option === currentQuestion.answer
                  ? 'bg-green-500 text-white transform scale-105'
                  : feedback && option !== currentQuestion.answer
                  ? 'bg-gray-200 text-gray-400'
                  : 'bg-blue-100 hover:bg-blue-200 text-blue-900 hover:transform hover:scale-105'
              }`}
            >
              {option}
            </button>
          ))}
        </div>
      ) : (
        <div className="flex flex-col items-center gap-4">
          <input
            type="number"
            value={userAnswer}
            onChange={(e) => setUserAnswer(e.target.value)}
            onKeyPress={(e) => {
              if (e.key === 'Enter' && userAnswer && !feedback) {
                handleAnswer(parseInt(userAnswer));
              }
            }}
            disabled={feedback !== null}
            className="w-32 p-4 text-2xl text-center border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
            autoFocus
          />
          {!feedback && (
            <button
              onClick={() => {
                handleAnswer(parseInt(userAnswer));
              }}
              disabled={!userAnswer || feedback !== null}
              className="px-6 py-3 bg-blue-500 text-white rounded-lg font-medium disabled:bg-gray-300 hover:bg-blue-600 transition-colors"
            >
              Svar
            </button>
          )}
        </div>
      )}

      {feedback && (
        <div className={`mt-6 p-4 rounded-lg text-center ${
          feedback.isCorrect ? 'bg-green-100' : 'bg-red-100'
        }`}>
          {feedback.isCorrect ? (
            <div className="flex items-center justify-center gap-2 text-green-700">
              <CheckCircle className="w-6 h-6" />
              <span className="text-lg font-medium">Rigtigt! Godt klaret!</span>
            </div>
          ) : (
            <div className="text-red-700">
              <XCircle className="w-6 h-6 mx-auto mb-2" />
              <p className="font-medium">Ikke helt...</p>
              <p className="text-lg mt-1">
                {currentQuestion.a} √ó {currentQuestion.b} = {feedback.correctAnswer}
              </p>
              <p className="text-sm mt-2 text-gray-600">Pr√∏v at huske det til n√¶ste gang!</p>
            </div>
          )}
        </div>
      )}

      {showNextButton && (
        <div className="mt-6 text-center">
          <button
            onClick={handleNextQuestion}
            className="px-6 py-3 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition-colors"
          >
            {sessionStats.total >= practiceLength - 1 ? 'Afslut √∏velse' : 'N√¶ste opgave ‚Üí'}
          </button>
        </div>
      )}
    </div>

    {sessionStats.total === practiceLength && (
      <div className="bg-green-50 p-4 rounded-lg text-center">
        <p className="text-lg font-medium text-green-900">
          √òvelsen er f√¶rdig! üéâ
        </p>
        <p className="text-sm text-green-700 mt-1">
          Du fik {sessionStats.correct} ud af {practiceLength} rigtige ({Math.round((sessionStats.correct / practiceLength) * 100)}%)
        </p>
      </div>
    )}
  </div>
);
```

};

// Stats component
const Stats = () => {
const masteredFacts = Object.entries(progress.facts)
.filter(([_, fact]) => fact.correct / fact.attempts >= 0.8 && fact.attempts >= 3)
.length;

```
const totalPossibleFacts = selectedTables.length * 10;
const progressPercentage = totalPossibleFacts > 0 ? Math.round((masteredFacts / totalPossibleFacts) * 100) : 0;

return (
  <div className="p-4 max-w-md mx-auto">
    <div className="flex items-center gap-4 mb-6">
      <button
        onClick={() => setCurrentMode('menu')}
        className="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors"
      >
        <ArrowLeft className="w-5 h-5" />
        <span>Tilbage</span>
      </button>
      <h2 className="text-2xl font-bold">Dine Fremskridt</h2>
    </div>
    
    <div className="bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg p-6 mb-6">
      <div className="text-center">
        <p className="text-5xl font-bold mb-2">{progressPercentage}%</p>
        <p className="text-blue-100">af valgte tabeller mestret</p>
      </div>
    </div>
    
    <div className="grid grid-cols-2 gap-4 mb-6">
      <div className="bg-white rounded-lg shadow p-4">
        <Trophy className="w-8 h-8 text-yellow-500 mb-2" />
        <p className="text-2xl font-bold">{progress.totalPoints}</p>
        <p className="text-sm text-gray-600">Point i alt</p>
      </div>
      
      <div className="bg-white rounded-lg shadow p-4">
        <Star className="w-8 h-8 text-blue-500 mb-2" />
        <p className="text-2xl font-bold">Niveau {progress.level}</p>
        <p className="text-sm text-gray-600">Dit niveau</p>
      </div>
      
      <div className="bg-white rounded-lg shadow p-4">
        <BarChart3 className="w-8 h-8 text-green-500 mb-2" />
        <p className="text-2xl font-bold">{masteredFacts}</p>
        <p className="text-sm text-gray-600">Mestrede tal</p>
      </div>
      
      <div className="bg-white rounded-lg shadow p-4">
        <Clock className="w-8 h-8 text-purple-500 mb-2" />
        <p className="text-2xl font-bold">{Object.keys(progress.facts).length}</p>
        <p className="text-sm text-gray-600">√òvede tal</p>
      </div>
    </div>
    
    <div className="bg-white rounded-lg shadow p-4">
      <h3 className="font-bold mb-3">Fremskridt per tabel</h3>
      {selectedTables.length === 0 ? (
        <p className="text-gray-500 text-center py-4">
          Ingen tabeller valgt. G√• til indstillinger for at v√¶lge tabeller.
        </p>
      ) : (
        selectedTables.sort((a,b) => a-b).map(table => {
          const tableFacts = Object.entries(progress.facts)
            .filter(([key]) => key.startsWith(`${table}x`));
          const mastered = tableFacts
            .filter(([_, fact]) => fact.correct / fact.attempts >= 0.8 && fact.attempts >= 3)
            .length;
          
          return (
            <div key={table} className="mb-3">
              <div className="flex justify-between text-sm mb-1">
                <span className="font-medium">{table}-tabellen</span>
                <span className="text-gray-600">{mastered}/10</span>
              </div>
              <div className="w-full bg-gray-200 rounded-full h-3">
                <div 
                  className="bg-gradient-to-r from-blue-400 to-blue-600 h-3 rounded-full transition-all duration-500"
                  style={{ width: `${(mastered / 10) * 100}%` }}
                />
              </div>
            </div>
          );
        })
      )}
    </div>
  </div>
);
```

};

// Main menu
const MainMenu = () => (
<div className="p-4 max-w-md mx-auto">
<div className="text-center mb-8">
<h1 className="text-3xl font-bold mb-2">Gangetabel Tr√¶ning</h1>
<p className="text-gray-600">L√¶r gangetabellerne p√• en sjov m√•de!</p>

```
    {selectedTables.length === 0 && (
      <div className="mt-4 p-3 bg-amber-50 text-amber-800 rounded-lg text-sm">
        ‚ö†Ô∏è Du skal v√¶lge tabeller i indstillinger f√∏r du kan √∏ve
      </div>
    )}
  </div>

  <div className="space-y-3 mb-6">
    <button
      onClick={() => setCurrentMode('practice')}
      disabled={selectedTables.length === 0}
      className={`w-full rounded-lg shadow-lg p-6 text-left transition-all flex items-center gap-4 ${
        selectedTables.length === 0 
          ? 'bg-gray-200 text-gray-400 cursor-not-allowed' 
          : 'bg-blue-500 text-white hover:bg-blue-600 hover:shadow-xl'
      }`}
    >
      <Play className="w-8 h-8" />
      <div>
        <h3 className="text-xl font-bold mb-1">Start √òvelse</h3>
        <p className={selectedTables.length === 0 ? 'text-gray-400' : 'text-blue-100'}>
          {selectedTables.length > 0 
            ? `${practiceLength} opgaver med ${selectedTables.sort((a,b) => a-b).join(', ')}-tabellerne`
            : 'V√¶lg tabeller i indstillinger f√∏rst'
          }
        </p>
      </div>
    </button>

    <button
      onClick={() => setCurrentMode('lookup')}
      className="w-full bg-white rounded-lg shadow-lg p-6 text-left hover:shadow-xl transition-all flex items-center gap-4"
    >
      <Book className="w-8 h-8 text-blue-500" />
      <div>
        <h3 className="text-xl font-bold mb-1">Se Tabeller</h3>
        <p className="text-gray-600">Sl√• op i alle gangetabeller</p>
      </div>
    </button>

    <button
      onClick={() => setCurrentMode('stats')}
      className="w-full bg-white rounded-lg shadow-lg p-6 text-left hover:shadow-xl transition-all flex items-center gap-4"
    >
      <BarChart3 className="w-8 h-8 text-green-500" />
      <div>
        <h3 className="text-xl font-bold mb-1">Fremskridt</h3>
        <p className="text-gray-600">Se dine resultater og statistik</p>
      </div>
    </button>

    <button
      onClick={() => setCurrentMode('settings')}
      className="w-full bg-white rounded-lg shadow-lg p-6 text-left hover:shadow-xl transition-all flex items-center gap-4"
    >
      <Settings className="w-8 h-8 text-gray-500" />
      <div>
        <h3 className="text-xl font-bold mb-1">Indstillinger</h3>
        <p className="text-gray-600">V√¶lg tabeller og √∏velsestype</p>
      </div>
    </button>
  </div>

  {progress.totalPoints > 0 && (
    <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 text-center">
      <p className="text-sm text-gray-600 mb-1">Du er niveau {progress.level}</p>
      <div className="flex items-center justify-center gap-2">
        <Trophy className="w-5 h-5 text-yellow-500" />
        <span className="text-lg font-bold">{progress.totalPoints} point</span>
      </div>
    </div>
  )}
</div>
```

);

return (
<div className="min-h-screen bg-gray-100">
{currentMode === ‚Äòmenu‚Äô && <MainMenu />}
{currentMode === ‚Äòlookup‚Äô && <LookupTable />}
{currentMode === ‚Äòpractice‚Äô && <Practice />}
{currentMode === ‚Äòstats‚Äô && <Stats />}
{currentMode === ‚Äòsettings‚Äô && <SettingsPage />}
</div>
);
};

export default GangetabelApp;
